#+TITLE: Notes On Improving raster scanning and CS scanning
#+SETUPFILE: ~/.emacs.d/org-templates/level-0.org
#+PROPERTY: TEMPLATE page_math
#+PROPERTY: URL projects/mpc_j.html 
#+PROPERTY: SAVE_AS projects/mpc_j.html
#+OPTIONS: tex:t
#+STARTUP: latexpreview
#+TODO: TODO(t) WAITING(w@/!) | DONE(d@/!) CANCELED(c@/!) STARTED(s@/!) DEFERRED(ef@/!)
#+STARTUP: fold
#+STARTUP: lognotestate t
#+SEQ_TODO: TODO STARTED WAITING DELEGATED APPT | DONE DEFERRED CANCELLED

* Introduction
The purpose of this document is to memoralize my work over the last few months trying to improve compressed sensing (CS) based imaging in the atomic force microscope (AFM). Along the way, raster scanning has improved dramatically as well. The two improvements that make the biggest difference to both modes are 

1. Mitigating external disturbances caused by building vibration and electrical noise. This is discussed in Section [[sec:noise]].
2. Building a compensator to cancell the complex pole-zero pair at 215 Hz (Section [[sec:z_comp]]). More work could be done here. For example, we could try an $H_{\infty}$ designed to damp the mode, rather than cancell it. We could also stick with the cancelletion and build an automated system identification routine to update the compensator every run (or so).

** Things specific to CS
The status here is less clear. In terms of the actual CS-scanning, I have explored several ways do the disengagement/move/engagement part of the CS scanning. I will talk about this in Section TK. One of the things that those exploration highlight is that drift in \(Z\)-piezo shows up the image data. One method to deal with this is what I'm calling "dynamic detrending," which I will discuss in [[sec:dyn_detrend]]. 

In most experimental CS images of the CS-20NG grating, we see a a ghosting of the holes. I show in Section [[sec:halos]] that this is due to the compressed nature of the resulting image. 


* Eliminiating Noise and disturbances <<sec:noise>>
Figures [[fig:no_iso]] and [[fig:with_iso]] show two 5 micron raster images taken at a 1~Hz scan speed. The images were taken with the same control settings and about 5 minutes apart with the same tip. The only difference between them is external disturbance mitigation. 

#+BEGIN_SUBFIG
#+ATTR_LATEX: :float nil 
#+caption: Raster image without vibration isolation and with fan plugged in
#+name: fig:no_iso
#+ATTR_HTML: :width 300
[[file:figures/raster_nobungee.svg]]
#+ATTR_LATEX: :float nil
#+caption: Raster scan with the vibration isolator and with the fan run from an external power supply. 
#+name: fig:with_iso
[[file:figures/raster_bungee.svg]]
#+END_SUBFIG

The two disturbance sources I have been able to identify and mitigate are building vibration and electrical noise. The blue curves in Figures [[fig:dfl_time]] and [[fig:dfl_psd]] show an experiment where the AFM tip is resting on the sample surface and \(Z\)-direction control loop is off. In these experiments, the \(XY\)-stage is turned on (more about this later). From the timeseries it is clear there is a low frequency oscillation. This is even clearer in the PSD, which shows a lot of energy in the shaded green band, ie, from about 10 Hz to about 60 Hz. 

#+BEGIN_SUBFIG
#+name: fig:dfl_time
#+caption: Time Series of the deflection signal. The blue curves are the unmodified instrument, the orange curves are the instrument with vibration isolation and the yellow curves are the with both vibration isolation and using an external power source to run the nPoint cooling fan.
#+ATTR_HTML: :width 250
file:figures/dfl_time.svg                              

#+name: fig:dfl_psd
#+caption: PSDs of the deflection signal. The shaded band indicates the domain region of building vibration.
#+ATTR_HTML: :width 250
file:figures/dfl_psd.svg                      
#+END_SUBFIG

The hypothesis is that this energy is due to the table which the AFM sits on shaking, probably because there are tiny vibrations in the building. This is such a common problem that ther are many [[https://www.herzan.com/afm-vibration-control.html][commercial]] [[https://www.thorlabs.com/newgrouppage9.cfm?objectgroup_id=1105][solutions]], which unfortunately cost lots money. These solutions are both active and pasive. The simplest passive isolation is to basically suspend the [[https://www.afmworkshop.com/afm-products/vibration-solutions/bungee-option][AFM from bungee cords]]. 

The idea behind passive vibration isolation is to insert a mechanical low pass filter between the driving vibration and the AFM itself. 
Once the principle is understood, it is faily easy to build one for about $50. The one I built is shown in Fig. [[fig:isolator]]. The principle is shown in in Fig. [[fig:schem_iso]]. 

#+BEGIN_SUBFIG
#+Caption: My home-built vibration isolation chamber
#+name: fig:isolator
#+ATTR_HTML: :width 300
[[file:figures/my_isolator.jpg]]

#+Caption: Mechanical schematic of vibration isolator.
#+name: fig:schem_iso
#+ATTR_HTML: :width 200
[[file:figures/mass-spring-damper.png]]
#+END_SUBFIG

We imagine the floor $z$ moving and transfering that motion through the springs (ie, bungee cords) into the motion $X$ of the AFM suport (ie, the concrete block). The transfer function from $Z$ to position $X$ is
\begin{equation}
    X(s) = \frac{\frac{\gamma}{m}s + \frac{k}{m}}{s^{2} + \frac{\gamma}{m}s + \frac{k}{m}} Z(s).
\end{equation}

We want to move the cuttoff frequency of this LPF as low as possible. To do that, we make $m$ as large as we can, since $\omega = \sqrt{k/m}$. Hence, the books sitting on the platform. One disadvantage of this type of system is that when we increase $m$, we decrease the damping. Thus, we can get a resonance. If you look at the marketing material for the active isolation systems, they harp on this quite a bit. 

Nonetheless, this thing seems to work really well. The orange curves in Figs [[fig:dfl_time]] and [[fig:dfl_psd]] are the results when using this isolation chamber. Although we have improved things considerably, the deflection signal is still rather noisy. This is due to the spike in the PSD at 380Hz. That spike is so sharp because, if we zoom on the orangetimeseries, we see almost a perfect sinusoid of 380 Hz.

Note also that the PSDs show resonances. These are from the xy-stage, which is turned on. These resonances show up in the deflection PSD because noise in xy-power amplifer perturbs the stage. To understand this, we need to understandd sample tilt, which is illustrated in the following video clip.

#+HTML: <video width="600" height="200" autoplay loop>
#+HTML: <source src="figures/sample_tilt.mp4" type="video/mp4">
#+HTML: Your browser does not support the video tag.
#+HTML: </video> 

It is through this mechanism that dynamics in xy-stage show up in the PSD of the deflection when the stage is powered on.
If we imagine that noise is white, then the position of the stage colored and shows up in the deflection signal largely through sample tilt. Some of what we see may also be to bending modes and runout in the xy-stage, though this is impossible to differentiate from tilt via just the deflection signal (at least, I don't know how). 

It turns out that the spike at 380 Hz in the PSD is caused by the cooling fan inside the xy stage power amplifier. If we unplug that fan, we get the yellow timeseries in Fig. [[fig:dfl_time]]  which is a vast improvement over the original instrument. 

*** TODO I think, at least for raster scanning, that most of the benefit is from the vibration isolation. I should redo this experiment to test the fan situation. I suspect it makes the most impact for CS imaging. 
*** TODO It would be interesting to regenerate this data with a longer window to increase the frequency resolution of the PSD, to see if we can see the resonance of the bungee cords.
* Bending Mode Compensation <<sec:z_comp>>
Talking about 215hz here.

* CS Scanning<<sec:CS>>
** Dynamic Detrending <<sec:dyn_detrend>>

** Implications for CS scanning
When raster scanning over a flat area, the control signal is now very, very flat. THis is shown by the orangecurves in [[fig:with_iso]]. I don't seem to be able to replicate that with CS-scanning. There seem to be multiple complicating factors.

1. When we do the descent, we excite the (extremely slow) drift modes in the z-piezo. This means that the $u_{z}$ control signal is still drifting even though the absolute z-position is relatively constant. Without a z-sensor, we introduce these dynamics into the CS image data. I have had some success eliminating this affect by modeling the drift and running the *entire* $u_{z}$ signal through the drift model in a post-processing step. This does not completely remove the affect though. 

   That middling success may be because, in the current implementation, each step up is different, depending on if the previous CS cycle ended in a whole or on the flats. This is a problem because, as I learned when modeling drift and hysteresis for x-direction, a linear drift models parameters should really change depending on how large the move is.
   
   It may therefore be better to to move up by a constant amount. I don't like stepping the control signal up because that tends to excite a lot of modes. What I could to is to keep the current method of reseting the $z$ reference when we step up, but by a larger than desired amount. Then, we keep moving up until some pre-determined $u_{z}$ threshhold is met.

   This scenario would be we would always start the descent from a known control value. However, there is no way to know if we will end up in a hole or on the flats. Thus, we cannot completely eliminate this affect. however, I think it would be best to normalize the drift model to the assumption that we end up on the flats, since that is where the affect seems most noticable.

2. It may be that putting $g_{drift}^{-1}$ in the loop, rather than using it in post-processing, will improve things.

2. On some descents, I still get oscillations. The frequency of the oscillations (from memory) seems to be either around the 215 Hz resonance, or much higher at around 600 Hz. I need to carefully compare the amplitude of these oscillations to what I see raster scanning on the flats. This occures despite the $D(z)^{-1}$ controller  which inverts the pz pair at 215 Hz. 

   I do not understand why sometimes that inversion works and sometimes it seems not too.

3. It is evident that the cantilevar is still interacting with the surface during the xy-move when we do not completely pull away. I seem to have some success turning of the PI controller during the xy-move. This prevents the controller from reacting to that interaction. Because the frequency content of the incoming (surface) disturbance is high (because we are moving fast), if we leave the PI controller on, we inject a high frequency signal into the loop. 

   Note that, if we were to keep applying the same reference at the end of the xy-move, then turning the PI loop back on would usually mean injecting a step command into the loop because the deflection signal will have changed between the beginning and end of the xy-move. I don't think this is a problem because when we turn the PI loop back on, we will also be changing the reference. Thus, we are already committed to injecting a step command into the loop. 

4. It may be that CS scanning will work much better on a larger image. Say 20 or 40 microns rather than 5. The reasoning is that for a larger image, the \(\mu\)-paths will become longer. This implies that the proportion of the \(\mu\)-path scan affected by the drift transient should be a much smaller fraction of the total scan length, and hence its affect on the image quality should be reduced. 

#+HTML: <figure>
#+caption: PSD of raster scan lines and CS scan paths over the flat area. Note the large peak in the CS curve at 215 Hz. 
#+name: fig:with_iso
[[file:figures/CS_raster_flats_PSD.svg]]
#+caption: This is caption two.
[[file:figures/CS_raster_flats_PSD_withFRF.svg]]
#+HTML: </figure>



# #+caption: PSD of raster scan lines and CS scan paths over the flat area. Note the large peak in the CS curve at 215 Hz. Also shown are the primary FRFs for the x-dir, y-dir, and z-dir.
# #+ATTR_HTML: :height 400
# #+name: fig:with_iso
# [[file:figures/CS_raster_flats_PSD_withFRF.svg]]

It is evident that the primary oscillations in the CS scan data correspond to the z-dir resonance at 215 Hz. The other two major peaks in the CS data are at 380 and 508 Hz. These appear to correspond to the (bending ?) modes of the x and y axes, respectively. 


Next step is to to the same analysis scanning over mica or a larger flat section. This will tell us if the trouble is that we are running into stuff during the move.
kkk



** Comparing Experimental to Simulation
I have been struggling to completely remove the the piezo dynamics from the CS scans. Those dynamics show up in two primary ways. 

1. Slow drift from the piezo. I have been able to remove most of this.
2. Oscillations at 215 Hz during the scanning portion of the cycle. It is evident that these oscillations are much larger when scanning over a flat portion of the sample than they are with raster scanning. 

To remove the drift, I fit a simple drift model and run the *entire* z-piezo control signal through that model. This is a post-processing step. It may be better to do that online, but I haven't gotten around to it yet. 

There is an resonance (complex pole-zero pair) in the z dynamics at about 215 Hz. In both the raster and CS scanning, I cancell that resonance. This lets me use a larger PI gain than I could otherwise. In both cases, the signal taken to represent the image is the control output of the integrator, before it goes into the inverse compensator. 

This inversion seems to work really well for raster scanning. In CS scanning, it works about the same as raster maybe a quarter of the time. In other cycles, the mode still gets excited. I don't understand why this.

I have been assuming that much of the graininess I see in the CS images is from those dynamics. If you look at a single row of the reconstructed images, it certainly looks like dynamics showing up. I tested this in a few ways. 

Perhaps the direct way to test this is to do CS reconstruction based on *perfect* data. The top left panel of Figure [[fig:cs_sim]] shows such an image. For that image, I generated a square, 512 x 512 matrix of all ones. Then, at the same size and guage as the CS20-NG grating, I filled in circles of zeros. I then subsampled that matrix with the same mask used in the experimental CS image. The basis-pursuit reconstruction is shown in the second panel on the left. 

The right column of panels shows experimental results. The top panel is a 1 Hz raster scan. The second panel is a CS image. 

In both columns, the bottom panel shows the row of pixels marked by the orangeline above. This demonstrates that much of the graininess and "oscillations" are actually from the reconstruction. 

TODO: Demonstrate this hypothesis
In fact, the red portion of the experimental curve shows the actually measured data.
We conclude then, at least as far as the actual image goes, there is no point to reducing the present dynamics any further. 


#+caption: (left: simulation. right: experiment) Top panels shows the matrix used to represent the CS-20NG. Middle panel shows the CS reconstruction. The top right panel shows a raster scan and the right middle panel shows an experiment CS reconstruction. The bottom panels show the data in a single row of pixels.
#+name: fig:cs_sim
file:figures/cs_compare_sim_sim.svg


The second, less direct way, is we can compare the frequency content of lines over flat areas to raster images. 



** The CS Halos <<sec:halos>>
   #+caption: Sorted DCT coefficients of the CS20-NG simulation image. The vertical dashed lines indicate the different threshholding fractions used in Figure~[[fig:cs20ng_thresh_img]].
   #+label: fig:cs20ng_dct
   #+ATTR_HTML: :height 350
   [[file:figures/cs20ng_sim_thresholds_mag.svg]]

   #+caption:Result of thresholding DCT coeficients. The top left image (100%) is the baseline, i.e., no thresholding.
   #+label: fig:cs20ng_thresh_img
   [[file:figures/cs20ng_sim_thresholds_img.svg]]
   
1. The haloing we get in experimental CS images is an artifact of CS, not my experimental implementation. We saw this in [[fig:cs_sim]]. We can also see this by taking the original image, converting to DCT, thresholding for the largest, say, $0.1*512^2$ coeficients, and conveting back to spatial domain. We still get the same halos, though not as noticable. This is illustrated in the following two figures.


   So really, that halo is some kind of periodicity that gets cancelled when we have all the coefficients. That strange and neat. I don't really see where that period is coming from though.

2. [[http://feihu.eng.ua.edu/compressive.pdf][This presentation]] is a good overview of CS. One of the things they say is that 2D wavelets are better than DCT for images with sharp edges. This makes sense because DCT is based on DFT, and we expect coeficients to not decay very fast for sharp transitions.
3. At the same time, "real" AFM images are generally much smoother than our calibration grating. So our results could, in that sense, be interpreted as a "worst case."
4. On the other hand, plotting the sorted log-magnitude of the DCT coeficients doesnt show much difference (any, really) between our holes and a normal test image.

5. Something that I'm confused about is why we do the CS recononstruction based off of a 1D DCT? Why not a 2D DCT? I have tried this, breifly. The results are not good and the reconstruction takes a very long time.

6. I have seen multiple places (Stack Exchange, that Tuma paper...) where people do their CS schemes on an already thresholded image. That is, they take a test image, take the dct, set N-k of the smallest  coefficients to zero, then convert back to spatial domain. This seems like an absurd thing to do if you want you results to bear any resemblence whatsoever to the real world.




#+caption: Comparison of simulated BP reconstructions from our CS20-NG test image.
#+label: fig:cs_sim_cp
[[file:figures/cs_sim_mu_path_vs_singlepix.svg]]

#+caption: Cs reconstructions using the 10% threshholded image.
#+label: fig:cs_sim_thresh
[[file:figures/cs_sim_mu_path_vs_singlepix_thresh.svg]]

Figure [[fig:cs_sim_thresh]] shows cs simulations using the 10% thresholded image as the master. They look basically identical to above. 
-- Need to check this.
-- ALso, recompute both this and above with PSNR or SSIM metrics.



* Footnotes

[fn:1] Before 



* Speed Comparison Tasks
:PROPERTIES:
:UNNUMBERED: t
:HTML_CONTAINER_CLASS: todosection
:END:
# set with C-c C-x p



# $$
# ref_{max} = [1, 2, 3, 4.8]
# $$
